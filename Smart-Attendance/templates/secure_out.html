<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Gate Exit (OUT) | Faculty Portal</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<link rel="stylesheet" href="/static/css/responsive.css">

<style>
:root{
  --primary:#1A73E8;
  --exit-red:#d93025;
  --bg:#f8f9fa;
  --shadow:0 4px 12px rgba(0,0,0,.08)
}
body{margin:0;font-family:'Segoe UI',sans-serif;display:flex;background:var(--bg)}

.sidebar{width:260px;height:100vh;position:fixed;background:#fff;border-right:1px solid #ddd}
.sidebar-header{padding:25px;font-size:22px;font-weight:700;color:var(--primary)}
.menu-item{padding:14px 25px;display:flex;gap:15px;color:#555;text-decoration:none}
.menu-item.active{background:#fee8e7;color:var(--exit-red);border-left:5px solid var(--exit-red)}

.main-content{margin-left:260px;width:calc(100% - 260px)}
.top-header{background:#fff;padding:12px 40px;display:flex;justify-content:flex-end;box-shadow:0 1px 3px rgba(0,0,0,.1)}
.content-body{padding:30px 40px}

.attendance-grid{display:flex;gap:25px}
.camera-box{flex:2;background:#fff;border-radius:20px;box-shadow:var(--shadow);padding:20px}
.video-container{position:relative;max-width:640px;margin:auto;aspect-ratio:4/3;background:#000;border-radius:12px;overflow:hidden}

video{
  width:100%;
  height:100%;
  object-fit:cover;
  transform:scaleX(-1)
}

#overlay-canvas{
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  pointer-events:none
}

.log-box{flex:1;background:#fff;border-radius:20px;box-shadow:var(--shadow);padding:25px}
#log-list{list-style:none;padding:0;margin:0}
#log-list li{
  padding:8px 0;
  border-bottom:1px solid #eee;
  font-size:13px;
  display:flex;
  justify-content:space-between;
  gap:12px;
}

#log-list li span{
  white-space:nowrap;
  overflow:visible;
}


.log-success{color:#1e8e3e;font-weight:bold}
.log-warning{color:#f29900;font-weight:bold}
.log-error{color:#d93025;font-weight:bold}
</style>
</head>

<body>

<div class="sidebar">
  <div class="sidebar-header">Faculty Portal</div>
  <a href="/faculty_dashboard" class="menu-item">Dashboard</a>
  <a href="/register" class="menu-item">Student Registration</a>
  <a href="/secure_in" class="menu-item">Start Entry (IN)</a>
  <a href="/secure_out" class="menu-item active">Start Exit (OUT)</a>
  <a href="/attendance_reports" class="menu-item">Reports</a>
  <a href="/logout" class="menu-item" style="margin-top:auto;color:#d93025">Logout</a>
</div>

<div class="main-content">
<div class="top-header"><b>Admin Faculty</b></div>

<div class="content-body">
<h2>Gate Exit (OUT)</h2>

<div class="attendance-grid">

<div class="camera-box">
  <div class="video-container">
    <video id="webcam" autoplay muted playsinline></video>
    <canvas id="overlay-canvas"></canvas>
  </div>
  <canvas id="hidden-canvas" style="display:none"></canvas>
</div>

<div class="log-box">
  <h4>Recent Exit Activity</h4>
  <ul id="log-list">
    <li style="color:#999;text-align:center">No activity yet</li>
  </ul>
</div>

</div>
</div>
</div>

<script>
let stream=null;
let scanInterval=null;
let lastLogged={};

const webcam=document.getElementById("webcam");
const overlayCanvas=document.getElementById("overlay-canvas");
const hiddenCanvas=document.getElementById("hidden-canvas");
const logList=document.getElementById("log-list");

async function startCamera(){
  try{
    await fetch('/api/toggle_attendance/OUT/start');

    stream=await navigator.mediaDevices.getUserMedia({video:true});
    webcam.srcObject=stream;
    webcam.play();

    scanInterval=setInterval(processFrame,1500);
  }catch(err){
    alert("Camera permission denied");
    console.error(err);
  }
}

async function processFrame(){
  if(!webcam.videoWidth) return;

  hiddenCanvas.width=webcam.videoWidth;
  hiddenCanvas.height=webcam.videoHeight;
  hiddenCanvas.getContext("2d").drawImage(webcam,0,0);

  const res=await fetch("/api/mark_attendance",{
    method:"POST",
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      image:hiddenCanvas.toDataURL("image/jpeg",0.75),
      mode:"OUT"
    })
  });

  const data=await res.json();
  if(data.success){
    drawBoxes(data.results);
    updateLog(data.results);
  }
}

function drawBoxes(results){
  overlayCanvas.width=webcam.videoWidth;
  overlayCanvas.height=webcam.videoHeight;
  const ctx=overlayCanvas.getContext("2d");
  ctx.clearRect(0,0,overlayCanvas.width,overlayCanvas.height);

  results.forEach(r=>{
    if(!r.box) return;

    const [x1,y1,x2,y2]=r.box;
    const mx=overlayCanvas.width-x2;

    ctx.strokeStyle=r.color||"yellow";
    ctx.lineWidth=3;
    ctx.strokeRect(mx,y1,x2-x1,y2-y1);

    ctx.fillStyle=r.color||"yellow";
    ctx.font="bold 15px Arial";
    ctx.fillText(r.reg_no,mx,y1-8);
  });
}

  function updateLog(results){

  const logList = document.getElementById("log-list");

  results.forEach(r=>{

    const now = Date.now();

    // ðŸ”´ UNKNOWN
    if(r.reg_no==="Unknown"){

      if(lastLogged["unknown"] && now-lastLogged["unknown"]<6000) return;
      lastLogged["unknown"]=now;

      if(logList.innerText.includes("No activity"))
        logList.innerHTML="";

      const li=document.createElement("li");
      li.className="log-error";
      li.innerHTML=`<span>Unknown Face</span><span>Not registered</span>`;
      logList.prepend(li);
      return;
    }

    // ðŸŸ¡ WAIT TIME MESSAGE
    if(r.status && r.status.includes("Wait")){

      if(lastLogged[r.reg_no+"_wait"] && now-lastLogged[r.reg_no+"_wait"]<6000) return;
      lastLogged[r.reg_no+"_wait"]=now;

      if(logList.innerText.includes("No activity"))
        logList.innerHTML="";

      const li=document.createElement("li");
      li.className="log-warning";
      li.innerHTML=`<span>${r.reg_no}</span><span>${r.status}</span>`;
      logList.prepend(li);
      return;
    }

    // ðŸŸ  IN NOT MARKED
    if(r.status && r.status.includes("IN not marked")){

      if(lastLogged[r.reg_no+"_noin"] && now-lastLogged[r.reg_no+"_noin"]<6000) return;
      lastLogged[r.reg_no+"_noin"]=now;

      if(logList.innerText.includes("No activity"))
        logList.innerHTML="";

      const li=document.createElement("li");
      li.className="log-warning";
      li.innerHTML=`<span>${r.reg_no}</span><span>IN not marked</span>`;
      logList.prepend(li);
      return;
    }

    // ðŸŸ¢ MARKED SUCCESS
    if(r.status && r.status.includes("Marked at")){

      if(lastLogged[r.reg_no] && now-lastLogged[r.reg_no]<6000) return;
      lastLogged[r.reg_no]=now;

      if(logList.innerText.includes("No activity"))
        logList.innerHTML="";

      const time=r.status.replace("Marked at ","");

      const li=document.createElement("li");
      li.className="log-success";
      li.innerHTML=`<span>${r.reg_no}</span><span>Marked at ${time}</span>`;
      logList.prepend(li);
      return;
    }

    // ðŸŸ  ALREADY MARKED
    if(r.status && r.status.includes("Already marked")){

      if(lastLogged[r.reg_no+"_dup"] && now-lastLogged[r.reg_no+"_dup"]<6000) return;
      lastLogged[r.reg_no+"_dup"]=now;

      if(logList.innerText.includes("No activity"))
        logList.innerHTML="";

      const time=r.status.replace("Already marked at ","");

      const li=document.createElement("li");
      li.className="log-warning";
      li.innerHTML=`<span>${r.reg_no}</span><span>Already at ${time}</span>`;
      logList.prepend(li);
      return;
    }

  });

  // Limit log size
  while(logList.children.length>20){
    logList.removeChild(logList.lastChild);
  }
}

window.onload=startCamera;
</script>

</body>
</html>
